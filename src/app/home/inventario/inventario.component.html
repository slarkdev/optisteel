<div class="main">
  <!-- Título -->
  <h1 class="page-title">Inventario</h1>
  <p class="subtitle"> <strong> Proyecto: {{ nombreProyecto }} Lote: {{ nombreLote }}</strong></p>
  <!-- Toolbar -->
  <div class="toolbar">
    <label class="search" role="search">
      <span class="icon"><mat-icon>search</mat-icon></span>
      <input
        type="search"
        placeholder="Buscar por perfil, material, calidad…"
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange($event)"
        aria-label="Buscar en inventario"
      />
    </label>

    <!-- <label class="select"> -->
      <!-- <span class="txt">{{ pageSize }} por página</span> -->
      <select [(ngModel)]="pageSize" aria-label="Filas por página"  class="select">
        <option [ngValue]="20">20 por página</option>
        <option [ngValue]="50">50 por página</option>
        <option [ngValue]="100">100 por página</option>
      </select>
      <!-- <span class="caret">▾</span> -->
    <!-- </label> -->

    <div class="filter" [attr.aria-expanded]="filtersOpen">
      <button class="btn btn-filter" type="button" (click)="toggleFilters()">
        <svg class="i"><use href="#i-filter" /></svg> Filtros
      </button>
      <div class="panel" *ngIf="filtersOpen" role="menu" aria-label="Filtros">
        <h4>Filtrar por</h4>

        <!-- Stock disponible -->
        <label class="frow">
        <input class="cb" type="checkbox" [(ngModel)]="onlyAvailable" (ngModelChange)="applyFilters()" />
        Sólo stock disponible
        </label>

        <!-- Perfiles dinámicos -->
        <h4>Perfiles</h4>
        <label class="frow" *ngFor="let p of perfilesFacetSig()">
          <input class="cb" type="checkbox"
                [checked]="selectedPerfiles().has(p)"
                (change)="togglePerfil(p, $any($event.target).checked)" />
          {{ p }}
        </label>
        <button class="btn btn-muted" type="button" (click)="clearFacet('perfil')">Limpiar perfiles</button>

        <!-- Calidades dinámicas -->
        <h4>Calidad</h4>
        <label class="frow" *ngFor="let c of calidadesFacetSig()">
          <input class="cb" type="checkbox"
                [checked]="selectedCalidades().has(c)"
                (change)="toggleCalidad(c, $any($event.target).checked)" />
          {{ c }}
        </label>
        <button class="btn btn-muted" type="button" (click)="clearFacet('calidad')">Limpiar calidades</button>
      </div>
    </div>

    <input #fileInput type="file" accept=".xlsx,.xls" hidden (change)="onFileInputChange($event)" />
    <button class="btn btn-primary" type="button" (click)="fileInput.click()"> <mat-icon>add</mat-icon> Agregar desde archivo</button>
    <button class="btn btn-muted" type="button" [disabled]="!anySelected()" (click)="confirmAndDeleteSelected()"> <mat-icon>delete</mat-icon> Borrar selección</button>
    <button class="btn btn-muted" type="button" [disabled]="!anySelected()" (click)="modificarCantidadLongitud()"> <mat-icon>edit</mat-icon>  Actualizar Datos</button>
  </div>

  <!-- Nota -->
  <div class="note">(*) Los campos marcados con asterisco son obligatorios.</div>

  <!-- Tabla -->
  <section class="card-table" aria-label="Inventario">
    <div class="table-wrapper">
      <table class="table" role="grid">
        <thead>
          <tr>
            <th>
              <input
                type="checkbox"
                class="cb"
                [checked]="masterChecked"
                [indeterminate]="masterIndeterminate"
                (change)="toggleAll($event)"
                aria-label="Seleccionar todos"
              />
            </th>
            <th>Perfil (*)</th>
            <th>Calidad (*)</th>
            <th>Longitud (*)</th>
            <th>Cantidad (*)</th>
            <th>Consumido</th>
            <th>Longitud de pieza más larga</th>
          </tr>
        </thead>
        <tbody>
          <tr class="row" *ngFor="let it of pagedItems; trackBy: trackById">
            <td><input class="cb" type="checkbox" [checked]="selected.has(it.id)" (change)="toggleOne(it.id, $event)" /></td>

            <!-- Perfil (editable) -->
            <td data-label="Perfil">
              <input class="cell-input"
                    [ngModel]="it.perfil"
                    (ngModelChange)="onCellEdit(it, 'perfil', $event)"
                     />
            </td>

            <!-- Calidad (editable, normalizada) -->
            <td data-label="Calidad">
              <input class="cell-input"
                    [ngModel]="it.calidad"
                    (ngModelChange)="onCellEdit(it, 'calidad', $event)"
                     />
            </td>

            <!-- Longitud (editable, numérico) -->
            <td data-label="Longitud">
              <input class="cell-input cell-num" type="number" min="0" step="1"
                    [ngModel]="it.longitud"
                    (ngModelChange)="onCellEdit(it, 'longitud', $event)"
                     />
            </td>

            <!-- Cantidad (editable numérico) -->
            <td data-label="Cantidad">
              <input class="cell-input cell-num" type="number" min="0" step="1"
                    [ngModel]="it.cantidad"
                    (ngModelChange)="onCellEdit(it, 'cantidad', $event)"
                     />
            </td>

            <!-- Consumido (no editable) -->
            <td data-label="Consumido">{{ it.consumido }}</td>
            <!-- Pieza más larga (no editable) -->
            <td data-label="Pieza más larga">{{ it.piezaMasLarga | number:'1.0-0':'en-US' }}</td>
          </tr>
          <tr *ngIf="pagedItems.length === 0">
            <td colspan="7" style="color:var(--muted);padding:20px">Sin resultados para tu búsqueda/filtros.</td>
          </tr>
          <!-- Fila en blanco para crear -->
          <tr class="row row-draft">
            <td><!-- sin checkbox --></td>

            <!-- Perfil -->
            <td data-label="Perfil">
              <input class="cell-input"
                    [ngModel]="newRow().perfil"
                    (ngModelChange)="onDraftEdit('perfil', $event)"
                    (blur)="saveDraftIfReady()"
                    placeholder="Nuevo perfil (*)" />
            </td>

            <!-- Calidad -->
            <td data-label="Calidad">
              <input class="cell-input"
                    [ngModel]="newRow().calidad"
                    (ngModelChange)="onDraftEdit('calidad', $event)"
                    (blur)="saveDraftIfReady()"
                    placeholder="Calidad (*)" />
            </td>

            <!-- Longitud -->
            <td data-label="Longitud">
              <input class="cell-input cell-num" type="number" min="0" step="1"
                    [ngModel]="newRow().longitud"
                    (ngModelChange)="onDraftEdit('longitud', $event)"
                    (blur)="saveDraftIfReady()"
                    placeholder="0" />
            </td>

            <!-- Cantidad -->
            <td data-label="Cantidad">
              <input class="cell-input cell-num" type="number" min="0" step="1"
                  [ngModel]="newRow().cantidad"
                  (ngModelChange)="onDraftEdit('cantidad', $event)"
                  
                  (blur)="saveDraftIfReady()"
                  placeholder="0" />
            </td>

            <!-- No editables -->
            <td data-label="Consumido">—</td>
            <td data-label="Pieza más larga">—</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Footer / pager -->
  <div class="tfoot" role="navigation" aria-label="Paginación">
    <span class="range">{{ rangeStart }}–{{ rangeEnd }} de {{ filtered.length }}</span>
    <div class="pager">
      <button class="iconbtn" title="Anterior" (click)="prevPage()" [disabled]="page===1">◀</button>
      <button class="iconbtn" title="Siguiente" (click)="nextPage()" [disabled]="page===totalPages">▶</button>
    </div>
  </div>

  <!-- Sprite local para el ícono de filtros -->
  <svg width="0" height="0" style="position:absolute">
    <symbol id="i-filter" viewBox="0 0 24 24"><path fill="currentColor" d="M3 5h18v2H3zm4 6h10v2H7zm3 6h4v2h-4z"/></symbol>
  </svg>
</div>
