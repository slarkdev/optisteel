<main class="main">
  <h1 class="page-title">Análisis</h1>
  <p class="subtitle">
    <strong>
      Proyecto: {{ proyectoSeleccionado?.name || "" }} Lote:
      {{ loteSeleccionado?.NombreTrabajo || "" }}</strong
    >
  </p>

  <div class="ctx" style="justify-content: space-between">
    <div>
      <mat-form-field style="width: 20rem">
        <mat-label>Filtro por Perfil</mat-label>
        <mat-select
          [formControl]="perfilesSeleccionados"
          (selectionChange)="buscarDatosConPiezasySinPiezas()"
          multiple
        >
          <mat-option
            (click)="toggleSelectAll($event)"
            [value]="selectAllValue"
          >
            Seleccionar Todo
          </mat-option>

          <mat-select-trigger>
            {{ perfilesSeleccionados.value?.[0]?.Perfil || '' }} -
            {{ perfilesSeleccionados.value?.[0]?.Calidad || '' }}

            @if ((perfilesSeleccionados.value?.length || 0) > 1) {
            <span class="perfiles">
              (+{{ (perfilesSeleccionados.value?.length || 0) - 1 }}
              {{
                perfilesSeleccionados.value?.length === 2 ? "other" : "others"
              }})
            </span>
            }
          </mat-select-trigger>
          @for (perfil of filtroInventarioPiezas; track perfil) {
          <mat-option [value]="perfil"
            >{{ perfil.Perfil }} - {{ perfil.Calidad }}</mat-option
          >
          }
        </mat-select>
      </mat-form-field>

      <button class="btn btn-ghost-1" (click)="ejecutarNesting()">
      <mat-icon>construction</mat-icon> Ejecutar Nesting
      </button>
    </div>

    <div class="actions">
      <button class="btn btn-ghost-1" (click)="actualizar()">
        <mat-icon>cached</mat-icon>Actualizar
      </button>
      <button class="btn btn-ghost" (click)="limpiar()"><mat-icon>cleaning_services</mat-icon> Limpiar</button>
      <button class="btn btn-ghost-1" (click)="exportar()"><mat-icon>cloud_download</mat-icon> Exportar</button>
      <button class="btn btn-primary" (click)="guardar()"><mat-icon>save</mat-icon> Guardar</button>
    </div>
  </div>

  <section class="fila">
    <div class="contenedor">
      <!-- Botones -->
      <label class="stock-indicator" title="Estado de stock">
        <span class="pill" data-stock="true">{{ stock }}</span>
      </label>

      <button
        class="kpi success"
        [class.active]="estadoSeleccionado === 'cubiertos'"
        (click)="toggleEstado('cubiertos')"
      >
        <span class="badge">✔</span> Cubiertos <strong>{{ nUsados }}</strong>
      </button>

      <button
        class="kpi warn"
        [class.active]="estadoSeleccionado === 'noCubiertos'"
        (click)="toggleEstado('noCubiertos')"
      >
        <span class="badge">✖</span> No Cubiertos
        <strong>{{ nNoUsados }}</strong>
      </button>

      <button
        class="kpi total"
        [class.active]="estadoSeleccionado === 'total'"
        (click)="toggleEstado('total')"
      >
        <span class="badge">Σ</span> Total <strong>{{ nTotal }}</strong>
      </button>
    </div>

    <!-- Panel desplegable debajo -->
    <div class="usados-panel" *ngIf="estadoSeleccionado">
      <p>{{ usadosParaMostrar }}</p>
    </div>
  </section>

  <!-- <div style="display: flex; flex-direction: row">
    <button class="btn btn-ghost" (click)="clickEvent($event)">
      <mat-icon>{{ hide ? "visibility_off" : "visibility" }}</mat-icon> Preview
    </button>
  </div> -->
  <div class="tabs" role="tablist">
    <div class="tabs" role="tablist">
      <button
        class="tab"
        role="tab"
        [attr.aria-selected]="tabSeleccionado === '1'"
        (click)="seleccionarTab('1')"
      >
        Patrones con empate
      </button>
      <button
        class="tab"
        role="tab"
        [attr.aria-selected]="tabSeleccionado === '2'"
        (click)="seleccionarTab('2')"
        [disabled]="configuracion?.Grappling || true"
      >
        Patrones sin empate
      </button>
      <button
        class="tab"
        role="tab"
        [attr.aria-selected]="tabSeleccionado === '3'"
        (click)="seleccionarTab('3')"
      >
        Resultados
      </button>
    </div>
  </div>

  <section
    class="card tabpanel"
    id="panel-sin"
    role="tabpanel"
    [hidden]="tabSeleccionado !== '1'"
  >
    <div class="card-hd">
      Patrones de corte
      <span class="muted"
        >· {{ dataPiezasConEmpate?.length || 0 }} resultados</span
      >
    </div>
    <div class="card-bd center muted">
      <app-tabla-analisis
        *ngIf="dataPiezasConEmpate?.length"
        [data]="dataPiezasConEmpate"
        [proyecto]="proyectoSeleccionado"
        [lote]="loteSeleccionado"
        [hide]="hide"
        [configuracion]="configuracion"
      ></app-tabla-analisis>
    </div>
  </section>

  <section
    class="card tabpanel"
    id="panel-sin"
    role="tabpanel"
    [hidden]="tabSeleccionado !== '2'"
  >
    <div class="card-hd">Patrones sin empate</div>
    <div class="card-bd center muted">
      <app-tabla-analisis
        *ngIf="dataPiezasSinEmpate?.length"
        [data]="dataPiezasSinEmpate"
        [proyecto]="proyectoSeleccionado"
        [lote]="loteSeleccionado"
        [hide]="hide"
        [configuracion]="configuracion"
      ></app-tabla-analisis>
    </div>
  </section>

  <section
    class="card tabpanel"
    id="panel-res"
    role="tabpanel"
    [hidden]="tabSeleccionado !== '3'"
  >
    <div class="card-hd">Resultados</div>
    <div class="card-bd center muted">
      Resumen final del nesting (placeholder).
    </div>
  </section>
</main>
